stages:

  # download dataset
  download_dataset:
    cmd: >-
      uv run python -m text_classification_example.download_dataset
      --dataset_name kunishou/J-ResearchCorpus
      --output_filepath data/raw/dataset.parquet
      --mlflow_run_name pipeline
    deps:
      - text_classification_example/download_dataset.py
      - text_classification_example/__init__.py
    outs:
      - data/raw/dataset.parquet

  # prepare dataset
  prepare_dataset:
    cmd: >-
      uv run python -m text_classification_example.prepare_dataset
      --input_filepath data/raw/dataset.parquet
      --output_train_filepath data/interim/dataset_train.parquet
      --output_valid_filepath data/interim/dataset_valid.parquet
      --output_test_filepath data/interim/dataset_test.parquet
    deps:
      - text_classification_example/prepare_dataset.py
      - data/raw/dataset.parquet
    outs:
      - data/interim/dataset_train.parquet
      - data/interim/dataset_valid.parquet
      - data/interim/dataset_test.parquet

  # train model
  train:
    foreach: ${train.config}
    do:
      cmd: >-
        echo uv run python -m text_classification_example.train
        ${item.model-name}
        --epochs ${item.epochs}
        --max-seq-length ${item.max-seq-length}
        data/interim/dataset_train.parquet
        data/interim/dataset_valid.parquet
        data/interim/dataset_test.parquet
      deps:
        - text_classification_example/train.py
        - data/interim/dataset_train.parquet
        - data/interim/dataset_valid.parquet
        - data/interim/dataset_test.parquet
      outs:
        - models/${item.name}/

  # evaluate model
  evaluate:
    foreach: ${train.config}
    do:
      cmd: >-
        echo uv run python -m text_classification_example.evaluate
        models/${item.name}/
        data/interim/dataset_test.parquet
        data/processed/${item.name}/metrics.json
      deps:
        - text_classification_example/evaluate.py
        - models/${item.name}/
        - data/interim/dataset_test.parquet
      outs:
        - data/processed/${item.name}/metrics.json
